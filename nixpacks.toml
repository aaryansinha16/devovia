[phases.setup]
aptPkgs = ["git"]
nixPkgs = ["pnpm", "nodejs_22"]

[phases.install]
cmds = [
  "pnpm install --frozen-lockfile"
]

[phases.build]
cmds = [
  "cd packages/database && pnpm exec prisma generate",
  "cd packages/database && pnpm exec tsc",
  "ls -la packages/database/dist/",
  "cd apps/api && pnpm exec prisma generate",
  "cd apps/api && pnpm exec tsc",
  "ls -la apps/api/dist/",
  "ls -la apps/api/node_modules/@repo/ || echo 'No @repo symlink'",
  "ls -la apps/api/node_modules/@repo/database/ || echo 'No database symlink'"
]

[start]
cmd = "cd apps/api && pnpm exec prisma migrate deploy && node dist/apps/api/src/index.js"
