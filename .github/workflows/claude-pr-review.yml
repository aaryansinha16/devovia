name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    # Skip draft PRs unless they have the 'claude' label
    if: |
      (github.event_name == 'pull_request' && (!github.event.pull_request.draft || contains(github.event.pull_request.labels.*.name, 'claude'))) ||
      (github.event_name == 'pull_request_review_comment') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@claude'))

    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}

            Review this PR for the Devovia project (Next.js 15 + Express + PostgreSQL monorepo).
            
            Read the project context from `.github/CLAUDE_CONTEXT.md` for detailed guidelines.
            
            Focus on:
            1. API response standardization (check `.github/CLAUDE_CONTEXT.md`)
            2. TypeScript type safety (no `any` types)
            3. Security issues (authentication, validation)
            4. Code quality and maintainability (SOLID, DRY)
            5. Performance issues (efficient Prisma queries, no N+1)
            
            ## Review Instructions - CRITICAL FOR PROPER GITHUB INTEGRATION

            **IMPORTANT**: Create proper GitHub review comments that can be resolved, NOT generic completion messages.

            ### How to Create Effective Review Comments:

            1. **Use Inline Comments for Specific Issues**:
               - Use `mcp__github_inline_comment__create_inline_comment` for line-specific feedback
               - Target specific files and line numbers where issues exist
               - Each comment should address ONE specific issue
               - Make comments actionable and specific

            2. **Create Resolvable Conversations**:
               - Each inline comment creates a "conversation" that can be resolved
               - Focus on specific code improvements, not general observations
               - Provide clear, actionable feedback that the author can address

            3. **Use Suggested Changes When Appropriate**:
               - For simple fixes, provide exact code suggestions
               - Use markdown code blocks with the language specified
               - Show the corrected code, not just describe the problem

            4. **Comment Structure**:
               ```
               **Issue**: [Brief description of the problem]

               **Suggestion**: [Specific recommendation]

               **Example**: [Code example if applicable]

               **Reason**: [Why this change improves the code]
               ```

            5. **Summary Comments**:
               - Use `gh pr comment` only for overall PR feedback or when @claude is mentioned
               - Summarize key findings and reference the inline comments

            ### What NOT to Do:
            - ❌ Don't post generic "I'll analyze this" messages
            - ❌ Don't create vague comments without specific line references
            - ❌ Don't post completion status updates

            ### Workflow:
            1. Start by running `gh pr diff` to see the changes.
            2. For each specific issue found, create an inline comment using the tool.
            3. Use the templates from `.github/claude-review-templates.md` for consistent feedback.
            4. End with a summary of critical issues if any, or a brief positive note.

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh issue comment:*),Read,Bash(find:*),Bash(grep:*)"
